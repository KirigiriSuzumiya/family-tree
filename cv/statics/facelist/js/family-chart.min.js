// https://donatso.github.io/family-chart/ v0.0.0 Copyright 2024 donatso
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("d3")):"function"==typeof define&&define.amd?define(["d3"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).f3=e(t.f3)}(this,(function(t){"use strict";function e(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var a=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,a.get?a:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var n=e(t),a="object"==typeof window&&window.d3?window.d3:n;function r(t,e,n){return n.find((n=>n.id!==e.id&&(n.id===t.rels.mother||n.id===t.rels.father)))}function i(t,e,n){if(t.exiting=n,e)0!==t.depth||t.spouse?t.spouse?(t._x=t.spouse.x,t._y=t.spouse.y):t.is_ancestry?(t._x=t.parent.x,t._y=t.parent.y):(t._x=t.psx,t._y=t.parent.y):(t._x=t.x,t._y=t.y);else if(n){const e=t.x>0?1:-1,n=t.y>0?1:-1;t._x=t.x+400*e,t._y=t.y+400*n}}function s(t,e){const n=e?"rels":"_rels",a=e?"_rels":"rels";function r(e){t.data[n]&&t.data[n][e]&&(t.data[a]||(t.data[a]={}),t.data[a][e]=t.data[n][e],delete t.data[n][e])}t.is_ancestry||t.data.main?(r("father"),r("mother")):function(){if(!t.data[n]||!t.data[n].children)return;const e=t.data[n].children.slice(0),r=t.spouse?[t.spouse]:t.spouses||[];[t,...r].forEach((t=>e.forEach((e=>{t.data[n].children.includes(e)&&(t.data[a]||(t.data[a]={}),t.data[a].children||(t.data[a].children=[]),t.data[a].children.push(e),t.data[n].children.splice(t.data[n].children.indexOf(e),1))}))))}()}function d(t,e){t.forEach((t=>{t.data.hide_rels=e,s(t,e)}))}function o(t,e){const n=t.rels,a=[n.father,n.mother,...n.spouses||[],...n.children||[]].filter((t=>!!t)),r=[];for(let n=0;n<a.length;n++){if(!i(e.find((t=>t.id===a[n])),[t])){r.push(a[n]);break}}return 0===r.length;function i(t,n){let a;return s(t)&&(a=[t]),function t(r,i){if(a)return;i=[...i,r],d((function(t){s(t)&&(a=i)})),a||d(o);function d(t){const e=r.rels;[e.father,e.mother,...e.spouses||[],...e.children||[]].filter((t=>t&&![...n,...i].find((e=>e.id===t)))).forEach((e=>t(e)))}function o(n){const a=e.find((t=>t.id===n));t(a,i)}}(t,[t]),a}function s(t){return"object"==typeof t?t.id===e[0].id:t===e[0].id}}function c(t,e){return delete t.to_add,t}function l(t,e){return u(t,e),!1}function u(t,e){return o(t,e)?(e.forEach((e=>{for(let n in e.rels)e.rels.hasOwnProperty(n)&&(e.rels[n]===t.id?delete e.rels[n]:Array.isArray(e.rels[n])&&e.rels[n].includes(t.id)&&e.rels[n].splice(e.rels[n].findIndex((e=>e===t.id)),1))})),e.splice(e.findIndex((e=>e.id===t.id)),1),e.forEach((t=>{t.to_add&&u(t,e)})),0===e.length&&e.push(g({}).data[0]),{success:!0}):{success:!1,error:"checkIfRelativesConnectedWithoutPerson"}}function h(t,e){const n=t.data.rels;return[n.father,n.mother,...n.spouses||[],...n.children||[]].filter((t=>t)).every((t=>e.some((e=>e.data.id===t))))}function f(){var t=(new Date).getTime(),e=performance&&performance.now&&1e3*performance.now()||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(n){var a=16*Math.random();return t>0?(a=(t+a)%16|0,t=Math.floor(t/16)):(a=(e+a)%16|0,e=Math.floor(e/16)),("x"===n?a:3&a|8).toString(16)}))}function p({datum:t,data_stash:e,rel_type:n,rel_datum:a}){function r(t){!function(){if(!a.rels.spouses)return;a.rels.spouses.forEach((t=>{const n=e.find((e=>e.id===t));n.to_add&&l(n,e)}))}(),a.rels.spouses||(a.rels.spouses=[]),a.rels.spouses.push(t.id),t.rels.spouses=[a.id]}"daughter"===n||"son"===n?function(t){t.data.other_parent&&(!function(n){"_new"===n&&(n=s().id);const i=e.find((t=>t.id===n));t.rels["M"===i.data.gender?"father":"mother"]=i.id,i.rels.hasOwnProperty("children")||(i.rels.children=[]);function s(){const t=_({rel_type:"spouse",rel_datum:a});return r(t),y({data_stash:e,datum:t}),t}i.rels.children.push(t.id)}(t.data.other_parent),delete t.data.other_parent);t.rels["M"===a.data.gender?"father":"mother"]=a.id,a.rels.children||(a.rels.children=[]);a.rels.children.push(t.id)}(t):"father"===n||"mother"===n?function(t){const n="M"===t.data.gender,r=a.rels[n?"father":"mother"];r&&l(e.find((t=>t.id===r)),e);a.rels[n?"father":"mother"]=t.id,function(){const r=a.rels[n?"mother":"father"];if(!r)return;const i=e.find((t=>t.id===r));t.rels.spouses=[r],i.rels.spouses||(i.rels.spouses=[]),i.rels.spouses.push(t.id)}(),t.rels.children=[a.id]}(t):"spouse"===n&&r(t)}function m({data:t,rels:e}){return{id:f(),data:t||{},rels:e||{}}}function _({data:t,rel_type:e,rel_datum:n}){const a=function(t,e){return["daughter","mother"].includes(e)||"spouse"===e&&"M"===t.data.gender?"F":"M"}(n,e);return m({data:t=Object.assign(t||{},{gender:a})})}function y({data_stash:t,datum:e}){t.push(e)}function g({data:t,version:e}){return{data:[m({data:t})],version:e}}function x({data:t,main_id:e=null,node_separation:n=250,level_separation:i=150}){const s=function(t){const e=[];for(let e=0;e<t.length;e++){const a=t[e];if(a.rels.children&&a.rels.children.length>0){a.rels.spouses||(a.rels.spouses=[]);const e="M"===a.data.gender;let r;a.rels.children.forEach((i=>{const s=t.find((t=>t.id===i));s.rels[e?"father":"mother"]===a.id&&(s.rels[e?"mother":"father"]||(r||(r=n(a),a.rels.spouses.push(r.id)),r.rels.children.push(s.id),s.rels[e?"mother":"father"]=r.id))}))}}return e.forEach((e=>t.push(e))),t;function n(t){const n=m({data:{gender:"M"===t.data.gender?"F":"M"},rels:{spouses:[t.id],children:[]}});return n.to_add=!0,e.push(n),n}}(t);!function(t){t.forEach((e=>{e.rels.children&&e.rels.children.sort(((n,a)=>{const i=t.find((t=>t.id===n)),s=t.find((t=>t.id===a)),d=r(i,e,t)||{},o=r(s,e,t)||{},c=e.rels.spouses.indexOf(d.id),l=e.rels.spouses.indexOf(o.id);return"M"===e.data.gender?c-l:l-c}))}))}(s);const d=null!==e?s.find((t=>t.id===e)):s[0],o=_(d,"children",!1),c=_(d,"parents",!0);s.forEach((t=>t.main=t===d)),function(t,e){const n=(t[0].x-e[0].x)/2;t.forEach((t=>t.x-=n)),e.forEach((t=>t.x+=n))}(c,o);const l=(f=o,(u=c).forEach((t=>{t.is_ancestry=!0})),u.forEach((t=>1===t.depth?t.parent=f[0]:null)),[...f,...u.slice(1)]);var u,f;!function({tree:t}){t.forEach((e=>{delete e.children,t.forEach((t=>{t.parent===e&&(t.is_ancestry?(e.parents||(e.parents=[]),e.parents.push(t)):(e.children||(e.children=[]),e.children.push(t)))}))}))}({tree:l}),function({tree:t,node_separation:e}){for(let n=t.length;n--;){const a=t[n];if(!a.is_ancestry&&a.data.rels.spouses&&a.data.rels.spouses.length>0){const n="M"===a.data.data.gender?-1:1;a.x+=a.data.rels.spouses.length/2*e*n,a.data.rels.spouses.forEach(((r,i)=>{const d={data:s.find((t=>t.id===r)),added:!0};d.x=a.x-e*(i+1)*n,d.y=a.y,d.sx=i>0?d.x:d.x+e/2*n,d.depth=a.depth,d.spouse=a,a.spouses||(a.spouses=[]),a.spouses.push(d),t.push(d),t.forEach((t=>t.data.rels.father===a.data.id&&t.data.rels.mother===d.data.id||t.data.rels.mother===a.data.id&&t.data.rels.father===d.data.id?t.psx=d.sx:null))}))}if(a.parents&&2===a.parents.length){const t=a.parents[0],n=a.parents[1],r=t.x-(t.x-n.x)/2,i=(t,n)=>r+e/2*(t.x<n.x?1:-1);n.x=i(t,n),t.x=i(n,t)}}}({tree:l,node_separation:n}),function({tree:t,is_vertical:e}){t.forEach((t=>{if(t.y*=t.is_ancestry?-1:1,!e){const e=t.x;t.x=t.y,t.y=e}}))}({tree:l,is_vertical:true}),l.forEach((t=>t.all_rels_displayed=h(t,l)));const p=function(t,e,n,r){r||([e,n]=[n,e]);const i=a.extent(t,(t=>t.x)),s=a.extent(t,(t=>t.y));return{width:i[1]-i[0]+e,height:s[1]-s[0]+n,x_off:-i[0]+e/2,y_off:-s[0]+n/2}}(l,n,i,true);return{data:l,data_stash:s,dim:p};function _(t,e,r){const d="children"===e?function(t){return[...t.rels.children||[]].map((t=>s.find((e=>e.id===t))))}:function(t){return[t.rels.father,t.rels.mother].filter((t=>t)).map((t=>s.find((e=>e.id===t))))},o=a.tree().nodeSize([n,i]).separation((function(t,e){let n=1;r||(l(t,e)||(n+=.25),function(t,e){return u(t)||u(e)}(t,e)&&(n+=function(t,e){return.5*((t.data.rels.spouses||[]).length+(e.data.rels.spouses||[]).length)}(t,e)),l(t,e)&&!function(t,e){return t.data.rels.father===e.data.rels.father&&t.data.rels.mother===e.data.rels.mother}(t,e)&&(n+=.125));return n})),c=a.hierarchy(t,d);return o(c),c.descendants();function l(t,e){return t.parent==e.parent}function u(t){return t.data.rels.spouses&&t.data.rels.spouses.length>0}}}function w({t:t,svg:e,transition_time:n=2e3}){const r=e.__zoomObj?e:e.parentNode,i=r.__zoomObj;a.select(r).transition().duration(n||0).delay(n?100:0).call(i.transform,a.zoomIdentity.scale(t.k).translate(t.x,t.y))}function $({svg:t,svg_dim:e,tree_dim:n,with_transition:a,transition_time:r}){w({t:v(e,n),svg:t,with_transition:a,transition_time:r})}function v(t,e){let n=Math.min(t.width/e.width,t.height/e.height),a=e.x_off+(t.width-e.width*n)/n/2,r=e.y_off+(t.height-e.height*n)/n/2;return n>1&&(a*=n,r*=n,n=1),{k:n,x:a,y:r}}function k({datum:t,svg:e,svg_dim:n,scale:a,transition_time:r}){const i=a||1;w({t:{k:i,x:(n.width/2-t.x*i)/i,y:(n.height/2-t.y)/i},svg:e,with_transition:!0,transition_time:r})}function M({d:t,tree:e,is_vertical:n}){const a=[];return t.data.rels.spouses&&t.data.rels.spouses.length>0&&function({d:t}){t.data.rels.spouses.forEach((n=>{const r=o(t,e,(t=>t.data.id===n));r&&!t.spouse&&a.push({d:[[t.x,t.y],[r.x,r.y]],_d:()=>[t.is_ancestry?[i(t,"x")-1e-4,i(t,"y")]:[t.x,t.y],t.is_ancestry?[i(r,"x"),i(r,"y")]:[t.x-1e-4,t.y]],curve:!1,id:[t.data.id,r.data.id].join(", "),depth:t.depth,spouse:!0,is_ancestry:r.is_ancestry})}))}({d:t}),function({d:t}){if(!t.parents||2!==t.parents.length)return;const e=t.parents[0],n=t.parents[1],i={x:r(e,n,"x"),y:r(e,n,"y")};a.push({d:s(t,i),_d:()=>s({x:t.x,y:t.y},{x:t.x,y:t.y}),curve:!0,id:d(t,t.parents[0],t.parents[1]),depth:t.depth+1,is_ancestry:!0})}({d:t}),function({d:t}){if(!t.children||0===t.children.length)return;t.children.forEach(((n,r)=>{const c=function(t,e,n){return o(e,n,(n=>n.data.id!==e.data.id&&(n.data.id===t.data.rels.mother||n.data.id===t.data.rels.father)))}(n,t,e),l=c.sx;a.push({d:s(n,{x:l,y:t.y}),_d:()=>s({x:l,y:t.y},{x:i(n,"x"),y:i(n,"y")}),curve:!0,id:d(n,t,c),depth:t.depth+1})}))}({d:t}),a;function r(t,e,n,a){return a?i(t,n)-(i(t,n)-i(e,n))/2:t[n]-(t[n]-e[n])/2}function i(t,e){return t.hasOwnProperty("_"+e)?t["_"+e]:t[e]}function s(t,e){const n=t.y+(e.y-t.y)/2;return[[t.x,t.y],[t.x,n],[t.x,n],[e.x,n],[e.x,n],[e.x,e.y]]}function d(...t){return t.map((t=>t.data.id)).sort().join(", ")}function o(t,e,n){const a=e.filter(n),r=(t,e)=>Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));return a.length>1?a.sort(((e,n)=>r(e,t)-r(n,t)))[0]:a[0]}}function b(t,e){const n=a.line().curve(a.curveMonotoneY),r=a.line().curve(a.curveBasis),i=e?t._d():t.d;return t.curve?!0===t.curve?r(i):void 0:n(i)}function E(t,e){const n=a.select(t).selectAll("div.card_cont_2fake").data(e,(t=>t.data.id)),r=n.exit(),i=n.enter().append("div").attr("class","card_cont_2fake").style("display","none").attr("data-id",(()=>Math.random())),s=i.merge(n);r.each((function(t){t.unique_id=a.select(this).attr("data-id"),a.select(this).remove()})),i.each((function(t){t.unique_id=a.select(this).attr("data-id")})),s.each((function(t){t.unique_id=a.select(this).attr("data-id")}))}function C(t){return a.select(t()).select("div.cards_view_fake").node()}var T=Object.freeze({__proto__:null,assignUniqueIdToTreeData:E,setupHtmlSvg:function(t){a.select(t()).append("div").attr("class","cards_view_fake").style("display","none")},getCardsViewFake:C,onZoomSetup:function(t,e){return function(n){const r=n.transform;a.select(t()).style("transform",`translate(${r.x}px, ${r.y}px) scale(${r.k}) `),a.select(e()).style("transform",`translate(${r.x}px, ${r.y}px) scale(${r.k}) `)}},setupReactiveTreeData:function(t){let e=[];return function(n){const a=function(t,e){return e.length>0?e.filter((e=>!t.find((t=>t.data.id===e.data.id)))):[]}(n,e);return e=[...n,...a],E(C(t),e),e}},getUniqueId:function(t){return t.unique_id}});function z(t,e){const n=800,a=Math.max(...t.data.map((t=>t.is_ancestry?t.depth:0)));let r=e.depth*n;return 0===e.depth&&!e.spouse||e.is_ancestry||(r+=a*n,e.spouse&&(r+=n),r+=e.depth*n),r}function P(t,{d:e}){return d(t.getTree().data,!1),t.updateMainId(e.data.id),t.updateTree({tree_position:t.state.tree_fit_on_change}),!0}function A(t,{d:e,cardEditForm:n}){const a=e.data;n({datum:a,postSubmit:e=>{a.to_add&&c(a,t.getData()),e&&e.delete&&(a.main&&t.updateMainId(null),u(a,t.getData())),t.updateTree()},store:t})}function L(t,{d:e}){e.data.hide_rels=!e.data.hide_rels,s(e,e.data.hide_rels),t.updateTree({tree_position:t.state.tree_fit_on_change})}function O({datum:t,data_stash:e,card_dim:n,labels:a}){const r=n.w+40,i=n.h+50,s=a||{};return{data:[{x:0,y:0,data:t=t||{id:"0",data:{fn:"FN",ln:"LN",gender:"M"}}},{x:-100,y:-i,data:{rel_type:"father",data:{label:s.father||"Add father",gender:"M"}}},{x:100,y:-i,data:{rel_type:"mother",data:{label:s.mother||"Add mother",gender:"F"}}},{x:r,y:0,data:{rel_type:"spouse",data:{label:s.spouse||"Add spouse",gender:"F"}}},{x:-100,y:i,data:{rel_type:"son",data:{label:s.son||"Add son",gender:"M"}}},{x:100,y:i,data:{rel_type:"daughter",data:{label:s.daughter||"Add daughter",gender:"F"}}}].filter((n=>{return"father"===(a=n.data.rel_type)?!t.rels.father||e.find((e=>e.id===t.rels.father)).to_add:"mother"!==a||!t.rels.mother||e.find((e=>e.id===t.rels.mother)).to_add;var a}))}}function F(t,{store:e,data_stash:n,cont:a,datum:r,card_dim:i,cardEditForm:s,scale:d}){const o=a.getBoundingClientRect(),c=function(t){return{k:d||1,x:t.width/2,y:t.height/2}}(o);return{template:`\n      <svg id="family-tree-svg" style="width: 100%; height: 100%">\n        <rect width="${o.width}" height="${o.height}" fill="transparent" />\n        <g class="view">\n          <g transform="translate(${c.x}, ${c.y})scale(${c.k})">\n            ${t.data.slice(1).map(((t,e)=>function({d:t,is_vertical:e}){return{template:`\n      <path d="${n()}" fill="none" stroke="#fff" />\n    `};function n(){const{w:n,h:a}=i;let r=e&&t.y<0?{x:0,y:-a/2}:e&&t.y>0?{x:0,y:a/2}:!e&&t.x<0?{x:-n/2,y:0}:!e&&t.x>0?{x:n/2,y:0}:{x:0,y:0};if(e)return"M"+t.x+","+t.y+"C"+t.x+","+(t.y+(t.y<0?50:-50))+" "+r.x+","+(r.y+(t.y<0?-50:50))+" "+r.x+","+r.y;{const e=t.x>0?1:-1;return"M"+t.x+","+t.y+"C"+(r.x+50*e)+","+t.y+" "+(r.x+150*e)+","+r.y+" "+r.x+","+r.y}}}({d:t,is_vertical:!["spouse"].includes(t.data.rel_type)}).template))}\n            ${t.data.slice(1).map(((t,e)=>function({d:t,is_main:e}){const[n,a]=e?[160,60]:[160,40],r={x:t.x,y:t.y};return{template:`\n      <g transform="translate(${r.x}, ${r.y})" class="card" data-rel_type="${t.data.rel_type}" style="cursor: pointer">\n        <g transform="translate(${-n/2}, ${-a/2})">\n          ${i({d:t,w:n,h:a}).template}\n        </g>\n      </g>\n    `};function i({d:t,w:e,h:n}){const a="M"===t.data.data.gender?"card-male":"F"===t.data.data.gender?"card-female":"card-genderless";return{template:`\n        <g>\n          <rect width="${e}" height="${n}" fill="#fff" rx="10" ${t.data.main?'stroke="#000"':""} class="${a}" />\n          <text transform="translate(0, ${n/4})">\n            <tspan x="10" dy="14">${t.data.data.label}</tspan>\n          </text>\n        </g>\n      `}}}({d:t}).template))}\n          </g>\n        </g>\n      </svg>\n    `,mounted:t=>{!function(t){function a(a){if(!a.closest(".card"))return;const i=a.closest(".card").getAttribute("data-rel_type"),d=r,o=_({rel_datum:d,rel_type:i});return s({datum:o,rel_datum:d,rel_type:i,postSubmit:()=>{t.remove(),y({data_stash:n,datum:o}),p({datum:o,data_stash:n,rel_datum:d,rel_type:i}),e.updateTree()},store:e}),!0}t.addEventListener("click",(e=>{a(e.target)||t.remove()}))}(t)}}}function j({d:t,card_dim:e,card_display:n}){return{template:`\n    <g>\n      <g class="card-text" clip-path="url(#card_text_clip)">\n        <text transform="translate(${e.text_x}, ${e.text_y})">\n          ${Array.isArray(n)?n.map((e=>`<tspan x="0" dy="14">${e(t.data)}</tspan>`)).join("\n"):n(t.data)}\n        </text>\n      </g>\n      <rect width="${e.w-10}" height="${e.h}" style="mask: url(#fade)" class="text-overflow-mask" /> \n    </g>\n  `}}function S({x:t,y:e,rt:n,closed:a}){return{template:`\n    <g style="\n          transform: translate(-12.2px, -.5px);\n          cursor: pointer;\n        " \n        fill="currentColor" class="card_break_link${a?" closed":""}"\n      >\n      <g style="transform: translate(${t}px,${e}px)scale(.02)rotate(${n+"deg"})">\n        <rect width="1000" height="700" y="150" style="opacity: 0" />\n        <g class="link_upper">\n          <g>\n            <path d="M616.3,426.4c19,4.5,38.1-7.4,42.6-26.4c4.4-19-7.4-38-26.5-42.5L522.5,332c-18,11.1-53.9,33.4-53.9,33.4l80.4,18.6c-7.8,4.9-19.5,12.1-31.3,19.4L616.3,426.4L616.3,426.4z"/>\n            <path d="M727.4,244.2c-50.2-11.6-100.3,3.3-135.7,35.4c28.6,22.6,64.5,30.2,116.4,51.3l141,32.6c23.9,5.6,56.6,47.2,51.1,71l-4.1,17c-5.6,23.7-47.3,56.4-71.2,51l-143.4-33.2c-66.8-8.6-104.1-16.6-132.9-7.5c17.4,44.9,55.9,80.8,106.5,92.4L800.9,588c81.3,18.8,162.3-31.5,181.2-112.4l4-17c18.8-81.1-31.7-161.8-112.9-180.6L727.4,244.2z"/>\n          </g>\n        </g>\n        <g class="link_lower">\n          <path d="M421.2,384.9l-128,127.6c-13.9,13.8-13.9,36.2,0,50s36.3,13.8,50.2,0.1l136.2-135.8v-36.7l-58.4,58.1V384.9L421.2,384.9z"/>\n          <path d="M204.6,742.8c-17.4,17.3-63.3,17.2-80.6,0.1l-12.3-12.3c-17.3-17.3,0.6-81.2,17.9-98.5l100.2-99.9c12.5-14.9,45.8-40.8,66.1-103.7c-47.7-9.4-98.9,4.2-135.8,40.9L54.2,575c-58.9,58.8-58.9,154,0,212.8L66.6,800c58.9,58.8,154.5,58.8,213.4,0l105.8-105.6c38.4-38.3,51.3-91.9,39.7-141c-44,22.7-89,62.3-116,84.8L204.6,742.8z"/>\n        </g>\n        <g class="link_particles">\n          <path d="M351.9,248.4l-26.5,63.4l80.6,30.1L351.9,248.4z"/>\n          <path d="M529.3,208l-43,26.6l35.4,52.3L529.3,208z"/>\n          <path d="M426.6,158.8l-44-2.9l61.7,134.6L426.6,158.8z"/>\n        </g>\n      </g>\n    </g>\n  `}}const H={miniTree:function(t,e){if(t.data.to_add)return;const n=e.card_dim;if(t.all_rels_displayed)return;const r=a.create("svg:g").html(function({d:t,card_dim:e}){return{template:`\n    <g class="card_family_tree" style="cursor: pointer">\n      <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n      <g transform="translate(${.8*e.w},6)scale(.9)">\n        <rect x="-31" y="-25" width="72" height="15" fill="rgba(0,0,0,0)"></rect>\n        <line y2="-17.5" stroke="#fff" />\n        <line x1="-20" x2="20" y1="-17.5" y2="-17.5" stroke="#fff" />\n        <rect x="-31" y="-25" width="25" height="15" rx="5" ry="5" class="card-male" />\n        <rect x="6" y="-25" width="25" height="15" rx="5" ry="5" class="card-female" />\n      </g>\n    </g>\n  `}}({d:t,card_dim:n}).template);return r.on("click",(function(n){n.stopPropagation(),e.onMiniTreeClick?e.onMiniTreeClick.call(this,n,t):P(e.store,{d:t})})),r.node()},lineBreak:function(t,e){if(t.data.to_add)return;const n=e.card_dim,r=a.create("svg:g").html(function({d:t,card_dim:e}){let n="",a=t.data.rels,r=t.data._rels||{},i=t.data.hide_rels,s=t=>t.father||t.mother,d=t=>t.children&&t.children.length>0;if((t.is_ancestry||t.data.main)&&(s(a)||s(r))&&(n+=S({x:e.w/2,y:0,rt:-45,closed:i}).template),!t.is_ancestry&&t.added){const s=t.spouse,o=s.data.rels,c=s.data._rels||{};(d(a)||d(r))&&(d(o)||d(c))&&(n+=S({x:t.sx-t.x+e.w/2+24.4,y:(t.x!==t.sx?e.h/2:e.h)+1,rt:135,closed:i}).template)}return{template:n}}({d:t,card_dim:n}).template);return r.on("click",(n=>{n.stopPropagation(),L(e.store,{d:t})})),r.node()},cardBody:function(t,e){const n=e.cardEditForm?"ADD":"UNKNOWN",r=e.card_dim;let i;t.data.to_add?(i=a.create("svg:g").html(function({d:t,card_dim:e,card_add:n,label:a}){return{template:`\n    <g class="card-body ${n?"card_add":"card-unknown"}">\n      <rect class="card-body-rect" width="${e.w}" height="${e.h}" fill="rgb(59, 85, 96)" />\n      <text transform="translate(${e.w/2}, ${e.h/2})" text-anchor="middle" fill="#fff">\n        <tspan font-size="18" dy="8">${a}</tspan>\n      </text>\n    </g>\n  `}}({d:t,card_dim:r,card_add:e.cardEditForm,label:n}).template),i.on("click",(n=>{n.stopPropagation(),A(e.store,{d:t,cardEditForm:e.cardEditForm})}))):(i=a.create("svg:g").html(function({d:t,card_dim:e,card_display:n}){return{template:`\n    <g class="card-body">\n      <rect width="${e.w}" height="${e.h}" class="card-body-rect" />\n      ${j({d:t,card_dim:e,card_display:n}).template}\n    </g>\n  `}}({d:t,card_dim:r,card_display:e.card_display}).template),i.on("click",(function(n){n.stopPropagation(),e.onCardClick?e.onCardClick.call(this,n,t):P(e.store,{d:t})})));return i.node()},cardImage:function(t,e){if(t.data.to_add)return;const n=e.card_dim;return a.create("svg:g").html(function({d:t,image:e,card_dim:n,maleIcon:a,femaleIcon:r}){return{template:`\n    <g style="transform: translate(${n.img_x}px,${n.img_y}px);" class="card_image" clip-path="url(#card_image_clip)">\n      ${e?`<image href="${e}" height="${n.img_h}" width="${n.img_w}" preserveAspectRatio="xMidYMin slice" />`:"F"===t.data.data.gender&&r?r({card_dim:n}):"M"===t.data.data.gender&&a?a({card_dim:n}):`\n      <g class="genderless-icon">\n        <rect height="${n.img_h}" width="${n.img_w}" fill="rgb(59, 85, 96)" />\n        <g transform="scale(${.001616*n.img_w})">\n         <path transform="translate(50,40)" fill="lightgrey" d="M256 288c79.5 0 144-64.5 144-144S335.5 0 256 0 112 \n            64.5 112 144s64.5 144 144 144zm128 32h-55.1c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16H128C57.3 320 0 377.3 \n            0 448v16c0 26.5 21.5 48 48 48h416c26.5 0 48-21.5 48-48v-16c0-70.7-57.3-128-128-128z" />\n        </g>\n      </g>\n    `}      \n    </g>\n  `}}({d:t,image:t.data.data.avatar||null,card_dim:n,maleIcon:null,femaleIcon:null}).template).node()},cardEdit:function(t,e){if(t.data.to_add)return;const n=e.card_dim,r=a.create("svg:g").html(function({d:t,card_dim:e,x:n,y:a}){return{template:`\n    <g transform="translate(${n||e.w-20},${a||e.h-20})scale(.6)" style="cursor: pointer" class="card_edit pencil_icon">\n      <circle fill="rgba(0,0,0,0)" r="17" cx="8.5" cy="8.5" />\n      <path fill="currentColor" transform="translate(-1.5, -1.5)"\n         d="M19.082,2.123L17.749,0.79c-1.052-1.052-2.766-1.054-3.819,0L1.925,12.794c-0.06,0.06-0.104,0.135-0.127,0.216\n          l-1.778,6.224c-0.05,0.175-0.001,0.363,0.127,0.491c0.095,0.095,0.223,0.146,0.354,0.146c0.046,0,0.092-0.006,0.137-0.02\n          l6.224-1.778c0.082-0.023,0.156-0.066,0.216-0.127L19.082,5.942C20.134,4.89,20.134,3.176,19.082,2.123z M3.076,13.057l9.428-9.428\n          l3.738,3.739l-9.428,9.428L3.076,13.057z M2.566,13.961l3.345,3.344l-4.683,1.339L2.566,13.961z M18.375,5.235L16.95,6.66\n          l-3.738-3.739l1.425-1.425c0.664-0.663,1.741-0.664,2.405,0l1.333,1.333C19.038,3.493,19.038,4.572,18.375,5.235z"/>\n    </g>\n  `}}({card_dim:n,x:n.w-46,y:n.h-20}).template);return r.on("click",(n=>{n.stopPropagation(),A(e.store,{d:t,cardEditForm:e.cardEditForm})})),r.node()},cardAdd:function(t,e){if(t.data.to_add)return;const n=e.card_dim,r=a.create("svg:g").html(function({d:t,card_dim:e,x:n,y:a}){return{template:`\n    <g class="card_add_relative">\n      <g transform="translate(${n||e.w/2},${a||e.h})scale(.13)">\n        <circle r="80" cx="40" cy="40" fill="rgba(0,0,0,0)" />\n        <g transform="translate(-10, -8)">\n          <line\n            x1="10" x2="90" y1="50" y2="50"\n            stroke="currentColor" stroke-width="15" stroke-linecap="round"\n          />\n          <line\n            x1="50" x2="50" y1="10" y2="90"\n            stroke="currentColor" stroke-width="15" stroke-linecap="round"\n          />\n        </g>\n      </g>\n    </g>\n  `}}({card_dim:n,x:n.w-26,y:n.h-20}).template);return r.on("click",(n=>{n.stopPropagation(),e.addRelative({d:t})})),r.node()}};function I(t,e,n){t&&(n?e.insertBefore(t,e.firstChild):e.appendChild(t))}return{CalculateTree:x,createStore:function(t){let e;const n=t;return{state:n,updateTree:t=>{n.tree=x({data:n.data,main_id:n.main_id,node_separation:n.node_separation,level_separation:n.level_separation}),e&&e(t)},updateData:t=>n.data=t,updateMainId:t=>n.main_id=t,getData:()=>n.data,getTree:()=>n.tree,setOnUpdate:t=>e=t,methods:{}}},view:function(t,e,n,r={}){r.initial=r.hasOwnProperty("initial")?r.initial:!a.select(e.parentNode).select(".card_cont").node(),r.transition_time=r.hasOwnProperty("transition_time")?r.transition_time:2e3,r.cardComponent?function(t,e,n,r={}){const s=a.select(C((()=>t))).selectAll("div.card_cont_fake").data(e.data,(t=>t.data.id)),d=s.exit(),o=s.enter().append("div").attr("class","card_cont_fake").style("display","none"),c=o.merge(s);d.each((t=>i(t,!1,!0))),o.each((t=>i(t,!0,!1))),d.each((function(t){const e=a.select(n(t)),i=a.select(this);e.transition().duration(r.transition_time).style("opacity",0).style("transform",`translate(${t._x}px, ${t._y}px)`).on("end",(()=>i.remove()))})),s.each((function(t){})),o.each((function(t){a.select(n(t)).style("position","absolute").style("top","0").style("left","0").style("opacity",0).style("transform",`translate(${t._x}px, ${t._y}px)`)})),c.each((function(t){const i=a.select(n(t)),s=r.initial?z(e,t):0;i.transition().duration(r.transition_time).delay(s).style("transform",`translate(${t.x}px, ${t.y}px)`).style("opacity",1)}))}(r.cardComponent,t,n,r):r.cardHtml?function(t,e,n,r={}){const s=a.select(t).select(".cards_view").selectAll("div.card_cont").data(e.data,(t=>t.data.id)),d=s.exit(),o=s.enter().append("div").attr("class","card_cont"),c=o.merge(s);d.each((t=>i(t,!1,!0))),o.each((t=>i(t,!0,!1))),d.each((function(t){const e=a.select(this);e.transition().duration(r.transition_time).style("opacity",0).style("transform",`translate(${t._x}px, ${t._y}px)`).on("end",(()=>e.remove()))})),s.each((function(t){})),o.each((function(t){a.select(this).style("position","absolute").style("top","0").style("left","0").style("transform",`translate(${t._x}px, ${t._y}px)`).style("opacity",0),n.call(this,t)})),c.each((function(t){n.call(this,t);const i=r.initial?z(e,t):0;a.select(this).transition().duration(r.transition_time).delay(i).style("transform",`translate(${t.x}px, ${t.y}px)`).style("opacity",1)}))}(r.cardHtml,t,n,r):function(t,e,n,r={}){const s=a.select(t).select(".cards_view").selectAll("g.card_cont").data(e.data,(t=>t.data.id)),d=s.exit(),o=s.enter().append("g").attr("class","card_cont"),c=o.merge(s);d.each((t=>i(t,!1,!0))),o.each((t=>i(t,!0,!1))),d.each((function(t){const e=a.select(this);e.transition().duration(r.transition_time).style("opacity",0).attr("transform",`translate(${t._x}, ${t._y})`).on("end",(()=>e.remove()))})),s.each((function(t){})),o.each((function(t){a.select(this).attr("transform",`translate(${t._x}, ${t._y})`).style("opacity",0),n.call(this,t)})),c.each((function(t){n.call(this,t);const i=r.initial?z(e,t):0;a.select(this).transition().duration(r.transition_time).delay(i).attr("transform",`translate(${t.x}, ${t.y})`).style("opacity",1)}))}(e,t,n,r),function(t,e,n={}){const r=e.data.reduce(((t,n)=>t.concat(M({d:n,tree:e.data}))),[]),i=a.select(t).select(".links_view").selectAll("path.link").data(r,(t=>t.id)),s=i.exit(),d=i.enter().append("path").attr("class","link"),o=d.merge(i);s.each((function(t){const e=a.select(this);e.transition("op").duration(800).style("opacity",0),e.transition("path").duration(n.transition_time).attr("d",b(t,!0)).on("end",(()=>e.remove()))})),d.each((function(t){a.select(this).attr("fill","none").attr("stroke","#fff").style("opacity",0).attr("d",b(t,!0))})),o.each((function(t){const r=a.select(this),i=n.initial?z(e,t):0;r.transition("path").duration(n.transition_time).delay(i).attr("d",b(t)).style("opacity",1)}))}(e,t,r);const s=r.tree_position||"fit";return r.initial?$({svg:e,svg_dim:e.getBoundingClientRect(),tree_dim:t.dim,transition_time:0}):"fit"===s?$({svg:e,svg_dim:e.getBoundingClientRect(),tree_dim:t.dim,transition_time:r.transition_time}):"main_to_middle"===s&&k({datum:t.data[0],svg:e,svg_dim:e.getBoundingClientRect(),scale:r.scale,transition_time:r.transition_time}),!0},createSvg:function(t,e={}){const n=t.getBoundingClientRect(),r=`\n    <svg class="main_svg">\n      <rect width="${n.width}" height="${n.height}" fill="transparent" />\n      <g class="view">\n        <g class="links_view"></g>\n        <g class="cards_view"></g>\n      </g>\n      <g style="transform: translate(100%, 100%)">\n        <g class="fit_screen_icon cursor-pointer" style="transform: translate(-50px, -50px); display: none">\n          <rect width="27" height="27" stroke-dasharray="13.5" stroke-dashoffset="6.75" \n            style="stroke:#fff;stroke-width:4px;fill:transparent;"/>\n          <circle r="5" cx="13.5" cy="13.5" style="fill:#fff" />          \n        </g>\n      </g>\n    </svg>\n  `,i=document.createElement("div");i.innerHTML=r;const s=i.firstElementChild;return t.style.position="relative",t.appendChild(s),function(t,e={}){if(t.__zoom)return;const n=t.querySelector(".view"),r=a.zoom().on("zoom",e.onZoom||i);a.select(t).call(r),t.__zoomObj=r,e.zoom_polite&&r.filter(s);function i(t){a.select(n).attr("transform",t.transform)}function s(t){return!("wheel"===t.type&&!t.ctrlKey)&&!(t.touches&&t.touches.length<2)}}(t,e),s},handlers:Object.freeze({__proto__:null,moveToAddToAdded:c,removeToAdd:l,deletePerson:u,manualZoom:function({amount:t,svg:e,transition_time:n=500}){const r=e.__zoomObj;a.select(e).transition().duration(n||0).delay(n?100:0).call(r.scaleBy,t)},isAllRelativeDisplayed:h,generateUUID:f,cardChangeMain:P,cardEdit:A,cardShowHideRels:L,handleRelsOfNewDatum:p,createNewPerson:m,createNewPersonWithGenderFromRel:_,addNewPerson:y,createTreeDataWithMainNode:g,addNewPersonAndHandleRels:function({datum:t,data_stash:e,rel_type:n,rel_datum:a}){y({data_stash:e,datum:t}),p({datum:t,data_stash:e,rel_type:n,rel_datum:a})},checkIfRelativesConnectedWithoutPerson:o,AddRelative:function({store:t,cont:e,card_dim:n,cardEditForm:r,labels:i}){return function({d:s,scale:o}){!o&&window.innerWidth<650&&(o=window.innerWidth/650),d(t.getTree().data,!1),t.updateMainId(s.data.id),t.updateTree({tree_position:"main_to_middle",transition_time:1e3,scale:o});!function(t){const e=F(O(t),t),n=document.createElement("div");n.style.cssText="width: 100%; height: 100%; position: absolute; top: 0; left: 0;background-color: rgba(0,0,0,.3);opacity: 0",n.innerHTML=e.template,t.cont.appendChild(n),e.mounted(n),a.select(n).transition().duration(t.transition_time).delay(t.transition_time/4).style("opacity",1)}({store:t,data_stash:t.getData(),cont:e,datum:s.data,transition_time:1e3,scale:o,card_dim:n,cardEditForm:r,labels:i})}},treeFit:$,calculateTreeFit:v,cardToMiddle:k}),elements:Object.freeze({__proto__:null,appendElement:I,Card:function(t){return function(t,e){function n(t,e,n){const{w:a,h:r}=t,i=e,s=n||[],d=t=>s.includes(t);return`${d("lx")?"M0,0":`M0,${i} Q 0,0 5,0`} ${d("rx")?`H${a}`:`H${a-i} Q ${a},0 ${a},5`} ${d("ry")?`V${r}`:`V${r-i} Q ${a},${r} ${a-i},${r}`} ${d("ly")?"H0":`H${i} Q 0,${r} 0,${r-i}`} z`}t.querySelector("defs#f3CardDef")||t.insertAdjacentHTML("afterbegin",`\n      <defs id="f3CardDef">\n        <linearGradient id="fadeGrad">\n          <stop offset="0.9" stop-color="white" stop-opacity="0"/>\n          <stop offset=".91" stop-color="white" stop-opacity=".5"/>\n          <stop offset="1" stop-color="white" stop-opacity="1"/>\n        </linearGradient>\n        <mask id="fade" maskContentUnits="objectBoundingBox"><rect width="1" height="1" fill="url(#fadeGrad)"/></mask>\n        <clipPath id="card_clip"><path d="${n({w:e.w,h:e.h},5)}"></clipPath>\n        <clipPath id="card_text_clip"><rect width="${e.w-10}" height="${e.h}"></rect></clipPath>\n        <clipPath id="card_image_clip"><path d="M0,0 Q 0,0 0,0 H${e.img_w} V${e.img_h} H0 Q 0,${e.img_h} 0,${e.img_h} z"></clipPath>\n        <clipPath id="card_image_clip_curved"><path d="${n({w:e.img_w,h:e.img_h},5,["rx","ry"])}"></clipPath>\n      </defs>\n    `)}((t=function(t){const e={img:!0,mini_tree:!0,link_break:!1,card_dim:{w:220,h:70,text_x:75,text_y:15,img_w:60,img_h:60,img_x:5,img_y:5}};t||(t={});for(const n in e)void 0===t[n]&&(t[n]=e[n]);return t}(t)).svg,t.card_dim),function(e){const n="M"===e.data.data.gender?"card-male":"F"===e.data.data.gender?"card-female":"card-genderless",r=t.card_dim,i=a.create("svg:g").attr("class",`card ${n}`).attr("transform",`translate(${[-r.w/2,-r.h/2]})`);i.append("g").attr("class","card-inner").attr("clip-path","url(#card_clip)"),this.innerHTML="",this.appendChild(i.node()),function(t,e,n){const a=document.createElementNS("http://www.w3.org/2000/svg","g");a.innerHTML=t,n?e.insertBefore(a,e.firstChild):e.appendChild(a)}(function({d:t,card_dim:e,is_new:n}){return{template:`\n    <rect width="${e.w}" height="${e.h}" rx="4" ry="4" class="card-outline ${t.data.main&&!n?"card-main-outline":""} ${n?"card-new-outline":""}" />\n  `}}({d:e,card_dim:r,is_new:e.data.to_add}).template,i.node(),!0),I(H.cardBody(e,t),this.querySelector(".card-inner")),t.img&&I(H.cardImage(e,t),this.querySelector(".card-inner")),t.mini_tree&&I(H.miniTree(e,t),this.querySelector(".card"),!0),t.link_break&&I(H.lineBreak(e,t),this.querySelector(".card")),t.cardEditForm&&(I(H.cardEdit(e,t),this.querySelector(".card-inner")),I(H.cardAdd(e,t),this.querySelector(".card-inner"))),t.onCardUpdate&&t.onCardUpdate.call(this,e)}}}),htmlHandlers:T}}));
